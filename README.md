# 图书管理系统

## 需求分析

#### 一、实体分析

| 实体               | 属性                                                                            | 关系说明                |
| ---------------- | ----------------------------------------------------------------------------- | ------------------- |
| **User**         | `id, name, email, google_id, password_hash, role(enum)`, join_date, is_active | 支持Google OAuth和邮箱登录 |
| **Admin**        | 继承自User实体，额外属性：`admin_level(enum)`                                            | 管理员分为超级管理员和普通管理员    |
| **Book**         | `isbn, title, publisher, publish_year`                                        | 核心书目元数据             |
| **BookCopy**     | `copy_id, book_isbn(FK), status(enum)`, location                              | 物理副本管理              |
| **Author**       | `id, name, bio, user_id(FK)`                                                  | 作者实体（可关联用户）         |
| **BorrowRecord** | `id, user_id(FK), copy_id(FK)`, borrow_date, due_date, return_date            | 借阅生命周期管理            |

**关键关系说明**：

1. 书-作者多对多：通过`book_author`关联表实现
   
   - 图书删除时自动解除关联

2. 作者-用户可选绑定：
   
   ```
   erDiagram
      USER ||--o{ AUTHOR : "可选关联"
      USER {
          string id PK
          string google_id
      }
      AUTHOR {
          string id PK
          string user_id FK "nullable"
      }
   ```

---

#### 二、功能需求

##### 用户模块（User）

| 功能     | 描述                  | 权限                 |
| ------ | ------------------- | ------------------ |
| 谷歌凭证登录 | 通过Google OAuth2.0实现 | 公开                 |
| 邮箱注册登录 | 使用邮箱和密码注册/登录        | 公开                 |
| 查看借阅记录 | 显示当前/历史借阅及归还状态      | 自身  (作者看到自己书的所有记录) |
| 修改个人信息 | 更新姓名、邮箱等基本信息        | 自身                 |

##### 图书管理模块

| 功能     | 描述              | 权限         |
| ------ | --------------- | ---------- |
| 添加新书   | 创建书目+初始副本（最少1本） | Admin      |
| 编辑图书详情 | 修改元数据（ISBN不可修改） | Admin      |
| 删除图书   | 需检查无借出副本才允许删除   | Admin      |
| 借阅图书   | 选择在馆副本生成借阅记录    | User       |
| 归还图书   | 更新副本状态+借阅记录     | User/Admin |

##### 管理员专属功能（Admin）

**普通管理员（ADMIN）**：

- **用户管理**：冻结/解冻普通用户账户
- **副本管理**：新增/报废图书副本
- **借阅监督**：查看所有借阅记录
- **系统维护**：配置借阅规则（借期）

**超级管理员（SUPER_ADMIN）**：

- 包含普通管理员的所有权限
- **权限管理**：提升普通用户为管理员，降级普通管理员
- **管理员管理**：冻结/解冻管理员账户
- **系统配置**：修改系统级别配置参数

---

#### 三、权限矩阵

| 操作         | User | Admin | Super Admin |
| ---------- | ---- | ----- | ----------- |
| 查看自身借阅记录   | ✔    | ✔     | ✔           |
| 借阅可用图书     | ✔    | ✔     | ✔           |
| 归还自己借阅的书   | ✔    | ✔     | ✔           |
| 创建/编辑/删除图书 | ✘    | ✔     | ✔           |
| 归还他人借阅的图书  | ✘    | ✔     | ✔           |
| 查看所有用户借阅历史 | ✘    | ✔     | ✔           |
| 管理普通用户账户状态 | ✘    | ✔     | ✔           |
| 管理管理员账户状态  | ✘    | ✘     | ✔           |
| 提升/降级用户权限  | ✘    | ✘     | ✔           |
| 系统级别配置     | ✘    | ✘     | ✔           |

---

#### 四、核心流程规范

1. **图书删除保护机制**：
   
   ```
   graph TD
      A[删除图书] --> B{检查副本状态}
      B -->|存在借出副本| C[终止操作并告警]
      B -->|全部在馆| D[解除作者关联]
      D --> E[删除所有副本]
      E --> F[删除书目]
   ```

2. **借阅生命周期**：
   
   - 借出：副本状态 → `BORROWED`
   - 归还：副本状态 → `AVAILABLE`
   - 超期：借阅记录标记`OVERDUE`（不阻塞归还）

3. **作者管理原则**：
   
   - 作者删除：当图书仍关联时禁止删除
   - 用户绑定：当作者关联用户时，需用户解绑才能删除

---

#### 五、特殊设计说明

1. **多种登录方式**：
   
   **谷歌登录集成**：
   
   ```
   用户流程：
   1. 前端调用Google OAuth
   2. 后端验证ID Token
   3. 系统自动注册/登录（存储google_id）
   4. 首次登录时提示补充姓名信息
   ```
   
   **邮箱注册登录**：
   
   ```
   注册流程：
   1. 用户输入邮箱、密码、姓名
   2. 系统验证邮箱格式和密码强度
   3. 发送邮箱验证码
   4. 用户验证邮箱后完成注册
   
   登录流程：
   1. 用户输入邮箱和密码
   2. 系统验证凭证
   3. 生成JWT Token完成登录
   ```

2. **实体操作边界**：
   
   - 普通用户：仅能操作自身数据
   - 普通管理员：具有图书和用户管理权限
   - 超级管理员：具有全局编辑权限，包括管理员权限管理
   - 作者实体：独立维护不影响用户系统

3. **系统初始化**：
   
   ```
   系统启动时的初始化流程：
   1. 检查是否存在超级管理员账户
   2. 如不存在，创建默认超级管理员账户
   3. 默认账户：admin@system.com / 系统生成密码
   4. 首次登录强制修改密码
   ```

4. **角色枚举定义**：
   
   ```
   UserRole枚举：
   - USER: 普通用户
   - ADMIN: 普通管理员
   - SUPER_ADMIN: 超级管理员
   
   AdminLevel枚举：
   - ADMIN: 普通管理员
   - SUPER_ADMIN: 超级管理员
   ```

---

## 数据库设计

[建表语句](sql/schema.sql)